@using SocialPulse.Core.ViewModels

@model InitSocialProfilesViewModel

@{
    ViewData["Title"] = "Strona główna";
}

<h2 class="mb-2">Profile</h2>

<input type="hidden" id="sessionGuid" value="@Model.SessionGuid" />

<div id="profilesContainer" class="row">
    @foreach (var profile in Model.SocialProfiles)
    {
        @await Html.PartialAsync("_SocialProfileOverview", profile)
    }
</div>

@section Scripts {
    <script>
            $(document).ready(function () {
            var sessionGuid = $("#sessionGuid").val();

            var connection = new signalR.HubConnectionBuilder()
                                        .withUrl("/cacheHub") 
                                        .build();

            connection.start()
                .then(function() {
                    console.log("Connected to CacheHub via SignalR.");

                    // Begin keep-alive ping every 30 seconds
                    setInterval(function() {
                        connection.invoke("KeepAlive", sessionGuid)
                            .catch(function (err) {
                                console.error("KeepAlive error: " + err.toString());
                            });
                    }, 30000);
                })
                .catch(function (err) {
                    console.error("Could not connect to CacheHub: " + err.toString());
                });

            var isLoading = false;
            var noMoreProfiles = false;

            $(window).on("scroll", function () {
                if (noMoreProfiles || isLoading) {
                    return;
                }

                if ($(window).scrollTop() + $(window).height() >= $(document).height() - 100) {
                    loadNextProfiles();
                }
            });

            function loadNextProfiles() {
                isLoading = true;

                $.ajax({
                  type: "GET",
                  url: "/Home/GetNextProfiles",
                  data: { sessionGuid: sessionGuid },
                  success: function (htmlResult) {
                    if (!htmlResult || htmlResult.length == 0) {
                      console.log("No more profiles.");
                      return;
                    }

                    $("#profilesContainer").append(htmlResult);
                  },
                  error: function (xhr, status, error) {
                    console.error("Error fetching next profiles:", error);
                  }
                });
            }

        });
    </script>
} 